---
layout: post
title: "arm-存储体系＜四＞"
subtitle: arm中MMU地址变换过程
author: "404"
header-style: text
tags:
  - Linux
  - arm
  - Memory
  - MMU
---

>本篇文章来源于《ARM体系结构与编程》，写得挺好

#### MMU中的地址变换过程

前面已经介绍过，虚拟存储空间到物理存储空间的映射是以内存块为单位进行的。即虚拟存储空间中一块连续的存储空间被映射成物理存储空间中同样大小的一块连续存储空间。在页表中(TLB中也是一样的)，每一个地址变换条目实际上记录了一个虚拟存储空间的春初快的基地址与物理存储空间相应的一个存储块的基地址对应关系。根据存储块大小，可以有多种地址变换。
ARM支持的存储块大小有以下几种：
- 段(section):是大小为1MB的存储块
- 大页(L;uge Pages): 是大小为64KB的存储块。
- 小页(Small Pages): 是大小为4KB的存储块。
- 极小页(Tiny Pages): 是大小为1KB的存储块。

通过采用另外的访问控制机制，还可以将大页分成大小为16KB的子页；将小页分成大小为1KB的子页；极小页不能再细分，只能以1KB大小的整页为单位。

在MMU中采用下面两级页表实现上述地址映射：
- 一级页表中包含有以段为单位的地址变换条目以及指向二级页表的指针。一级页表实现的地址映射粒度较大
- 二级页表中包含以大页和小页为单位的地址变换条目。其中，一种类型的二级页表还包含有以极小页为单位的地址变换条目

通常，以段为单位的地址变换过程只需要一级页表。而以页为单位的地址变换过程还需要二级页表。下面介绍这些地址变换过程。

##### 1. **基于一级页表的地址变换过程**

###### 基于一级页表的地址变换过程：

  这里将只涉及一级页表的地址变换过程称为一级地址变换过程。
  一级地址变换过程如下图。CP15寄存器C2中存放的是内存中页表基地址。其中位[31:14]为内存中页表的基地址，位[13:0]为0.因此一级页表的基地址必须是16KB对齐的。CP15寄存器C2的位[31:14]和虚拟地址的位[31:20]结合，作为一个32位数的高30位，再将该32位数的低两位置为00，从而形成一个32位的索引值。使用该32位的索引值从页表中可以查找到一个4字节的地址变换条目。该条目中或者包含了一个一级的描述符(First-level Descriptor),或者包含了一个指向二级页表的指针。
   ![avatar](/img/in-post/Linux/201931103004.png)
  根据上面的过程，可以得到页表中相应的地址变换条目。该条目称为一级描述符。一级描述符定义了与之相应的1MB存储空间是如何映射的。一级描述符的位[1:0]定义了该一级描述符的类型，共有以下4种格式的一级描述符：
  - 如果位[1:0]为0B00, 相应的1MB虚拟存储空间没用被映射到物理存储空间，因而访问该存储空间将产生地址变换失效信号。MMU硬件没有使用位[31:2], 软件可以使用它
  - 如果位[1:0]为0b10, 该级描述符为段描述符(Section Descriptor), 段描述符定义了对应的 1MB 的虚拟存储空间的地址映射关系
  - 如果位[1:0]为0b01, 该一级描述符中包含了粗粒度的二级页表的物理地址。该粗粒度的二级页表定义了对应的1MB的虚拟存储空间的地址映射关系。它可以实现以大页和小页为单位的地址映射。
  - 如果位[1:0]为0B11, 该一级描述符中包含了细粒度的二级页表的物理地址。该细粒度的二级页表定义了对应的 1MB 的虚拟存储空间的地址映射关系。它可以实现以大页、小页和极小页为单位的地址映射

   ![avatar](/img/in-post/Linux/201931103005.png)

###### 段描述符及其地址转换过程：

当一级描述符的位[1:0]为0b10时，该一级描述符为段描述符(Section Descriptor)，其格式如下：
![avatar](/img/in-post/Linux/201931103006.png)
其中，各字段的含义如下：
![avatar](/img/in-post/Linux/201931103007.png)
![avatar](/img/in-post/Linux/201931103008.png)
基于段的地址变换的过程如下：
![avatar](/img/in-post/Linux/201931103009.png)

###### 粗粒度页表描述符

当一级描述符的位[1:0]为0b01时，该一级描述符中包含了粗粒度的二级页表的物理地址，这种一级描述符称为粗粒度页表描述符。其格式如下：
![avatar](/img/in-post/Linux/201931103010.png)
其中，各字段的含义如下：
![avatar](/img/in-post/Linux/201931103011.png)
由粗粒度页表描述符获取二级描述符(Second-level Descriptor)的过程如下：
![avatar](/img/in-post/Linux/201931103012.png)

###### 细粒度页表描述符

当一级描述符的位[1:0]为0b11时，该一级描述符中包含了粗粒度的二级页表的物理地址，这种一级描述符称为细粒度页表描述符。其格式如下：
![avatar](/img/in-post/Linux/201931103013.png)
其中各字段含义如下：
![avatar](/img/in-post/Linux/201931103014.png)
细粒度页表描述符获取二级页表和细粒度的二级页表：
![avatar](/img/in-post/Linux/201931103015.png)
