---
layout: post
title: "Linux-arm-arm指令"
subtitle: arm linux中的汇编指令分析
author: "404"
header-style: text
tags:
  - Linux
  - arm
  - 汇编
---

>本篇文章为原创，转载请注明！

这篇文章中我们来分析`arm linux`中两条汇编指令：`adr`、`ldr`。在分析这两条指令前，我们得先聊一下arm体系对应的流水线：


![avatar](/img/in-post/Linux/201931001001.jpg)
![avatar](/img/in-post/Linux/201931001002.jpg)

从上图可以看出,`arm7`是三级流水线体系，那么在指令执行过程中会出现如下步骤：
- 取指
- 译码
- 执行

一般地址总线，数据总线为32位，那么执行一条指令后`PC = PC + 4`，而arm体系将其分为三个阶段，如图可以看出，在第一条指令取指后，进入第一条指令译码阶段；同时开始第二条指令的取指
，则此时`PC = PC + 4`，所以在第一条指令执行的时候，`PC = PC + 8`。在理解赐个基础上，我们来进行`adr`、`ldr`汇编伪指令分析。

#### ADR（小范围的地址读取伪指令）
该指令将基于PC的地址值或基于寄存器的地址值读取到
寄存器中。

##### 语法格式
ADR{cond} register,expr

其中：
- cond为可选的指令执行的条件
- register为目标寄存器
- expr为基于PC或者基于寄存器地址的地址表达式

在汇编编译器处理源程序时，`adr`伪指令被编译器替换成
一条合适的指令。通常，编译器用一条ADD指令或者SUB
指令来实现该`adr`伪指令的功能。如果不能用一条指令
来实现`adr`伪指令的功能，编译器将报告错误。

因为`adr`伪指令中的地址是基于PC或者基于寄存器的，所以
`adr`读取到的地址为地址无关的地址。当`adr`伪指令
中的地址是基于PC时，该地址与`adr`伪指令必须在同一个
代码段中。如下：
```c
start: MOV r0，#10;
	   ADR r4,start;		//本ADR伪指令将被编译器替换成 SUB r4,pc,#0xc
```
我们假设最先的指令寄存器的值是`PC`,走到`ADR r4,start`
后，指令寄存器的值是`PC2 = PC + 12`，这里我们理解三级流水线
就是超前取了一条指令，上述每条指令为4字节，再超前一条
指令就是12了，所以此时`start`基于`pc2`就是`-12`,
用十六进制表示就是`0xc`。

#### LDR（大范围的地址读取指令）
LDR伪指令将一个32位的常熟或者一个地址值读取到寄存器中。

#### 语法格式
LDRP{cond} register,=[expr|label-expr]
其中的符号及参数说明如下：
- cond为可选的指令执行的条件。
- register为目标寄存器。
- expr为32位的常量。编译器将根据expr的取值情况，处理LDR伪指令如下
  - 当expr表示的地址没有超过MOV或者MVN指令中地址的取值范围时，编译器
用合适的MOV或者MVN指令代替该LDR伪指令。
  - 当expr表示的地址值超过了MOV或MVN指令中地址的取值范围时，编译器
将该常数放在数据缓冲区中，同时用一条基于PC的LDR指令读取该常数。
- label-expr为基于PC的地址表达式或者是外部表达式。当label-expr为基于PC的地址
表达式时，编译器将label-expr表示的数值放在数据缓冲区中，同时用一条基于PC的
LDR指令读取该数值。当label-expr为外部表达式，或者非当前段的表达式时，汇编编译器将
在目标文件中插入连接重定位伪操作，这样连接器将在连接时生成该地值。

LDR伪指令主要有以下两种用途：
- 当需要读取到寄存器中的数据超过MOV及MVN指令可以操作的范围时，可以使用
LDR伪指令将该数据读取到寄存器中。
- 将一个基于PC的地址值或者外部的地址值读取到寄存器中。由于这种地址值是
在连接时确定的，所以这种代码不是位置无关的。同时，LDR伪指令处的PC值到
数据缓冲区中的目标数据所在的地址的偏亮要小于4KB。

```c
LDR r1, = 0xFF0
等价于
MOV R1, 0xFF0

LDR r1, =0xFFF
等价于
LDR R1,[PC, OFFSET_TO_LPOOL]
...
LPOOL DCD 0xFFF

LDR r1, =ADDR1   //将外部地址ADDR1读取到r1中
等价于
LDR r1,[PC, OFFSET_TO_LPOOL]
...
LPOOL DCD ADD1
```




