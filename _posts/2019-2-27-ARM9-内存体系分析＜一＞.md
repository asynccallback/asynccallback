---
layout: post
title: "ARM9-内存体系分析＜一＞"
subtitle: '此篇文章是基于S3C2440芯片，带具体SDRAM芯片结构来进行内存解析'
author: "404"
header-style: text
tags:
  - ARM9
  - S3C2440
  - Memory
---

>此篇文章为原创，转载请注明出处。

基于前面文章介绍，我们大致了解了内存的一些知识，此篇文章结合具体CPU,芯片来进行内存分析。此次我们用的CPU是S3C2400,SDRAM芯片是EM63A165TS-6G。别问为什么选这两款，因为我买的JZ2440开发板上就带的这两款。

#### CPU寻址

首先我们对CPU寻址有一个大致了解，CPU与内存连接图如下,下图中具体芯片名称和我们选择的不同，但是连线是一样的：
![avatar](/img/in-post/Linux/201922701001.png)
在此图中我们看到地址线是Addr[26:0],一共27根，CPU的具体管脚见下：
![avatar](/img/in-post/Linux/201922701002.png)
能寻址的地址空间范围是`0~128M`,而我们根据S3C2440芯片手册，得知内存区域划分如下：
![avatar](/img/in-post/Linux/201922701003.png)

那么我们如何根据这27根芯片来寻址1G的空间？同时我们发现这27根线能寻址的空间恰好等于每块Bank中的地址范围，也就是说这27跟线就只够我们`直连`一块内存芯片，那么剩下的7块怎么办？很显然，多加线就行，但我们把这些线不叫地址线，我称之为\"芯片选择线\"，即CPU芯片图中的NGCS0、NGCS1、NGCS2、NGCS3、NGCS4、NGCS5、NGCS6、NGCS7，此时8根\"芯片选择线\"就可以将对于地址范围扩展到1G。

那么这27跟地址线如何在SDRAM中寻址呢，以前我们文章分析过，内存IC中分为几片BANK，我们将这些地址线解析出来，此时根据地址线中区分去一个片选信号，来选中其中一个BANK。以前我们分析过SDRAM中BANK的结构，大致如下：
![avatar](/img/in-post/Linux/201922601001.png)
既然分为行、列，那么就应该是通过行列来寻址，我们来看芯片厂商给的结构图：
![avatar](/img/in-post/Linux/201922701004.png)
其中行、列都是用的同样的地址线，这就引申出了如何确定什么时候是行地址，什么时候是列地址。我们看到芯片图中有RAS#、CAS#两个信号接口，这两个接口就是用来确定什么时候是行地址，什么时候是列地址，这个就得考虑到芯片的时序图，以后分析。

此时我们会想行地址和列地址大小是否一样大，这个一般是不一样大的，我们同样根据厂商对芯片的描述：
![avatar](/img/in-post/Linux/201922701005.png)
上图我们可以看出，对于`EM63A165TS-6G`,A0-A12用来作为行地址，A0-A8用作列地址，那么每个BANK的大小为：2^13*2^9*每个cell大小（这里是16bit）= 8MB，然后每个IC中含有4块BLANK，这这块先大小是32MB。

此时，我们还会发现一个怪异现象。内存芯片上A0连接的是LADD2,相当于连接CPU芯片上的A2，可为什么不直接连接到CPU芯片上A0呢，CPU芯片上A0、A1此时都没连接到内存，它们干嘛去了呢？

此时我们需要明白一个概念。一个32bit的cpu发出一条指令后，它不管内存是什么形状（8bit、16bit、还是32bit），他只管要他所需的东西。比如cpu发出如下指令：
```
ldrB r0， =0x1;
```
当我们取地址编号为1其中的8个bit时，对应不同位数内存取出的结果：
![avatar](/img/in-post/Linux/201922701006.png)
当是8bit位内存时，是直接取出；16位bit内存时，是取出0,1；32位bit内存时，是取出0,1,2,3；那么如何从16位bit和32位bit内存中再选出想要的数据呢？

此时我们先看一下S3C2440对于连线的说明：
![avatar](/img/in-post/Linux/201922701007.png)
内存位为8bit时，LADDR0连接A0；内存位为16bit时，LADDR0连接A1；内存位为32bit时，LADDR0连接A2；对应此时8bit，地址相当于0x0000 0001；
16bit，相当于0x0000 0000，因为LADDR0没有接入内存；同理32bit。而此时A0、A1可以理解为片选信号，再从对应的2个单元格、4个单元格中选出正确的给cpu，16位只有A0，选1;32为A0、A1，为01，选1。

从这里也能理解出，地址空间的存储大小跟内存有关，跟CPU地址线位数无关，存多大是内存的事。

我们这块板子SDRAM是64MB，而CPU含有27跟地址线，可寻址地址范围就有128M，那么两者间如何联系起来呢？同样我们看S3C2440芯片手册：
![avatar](/img/in-post/Linux/201922701008.png)
我们对应的为红线部分，用2块SDRAM组成而成，我们发现会将A[25:24]连接到内存芯片的BA0、BA1作为芯片的L-BANK（不清楚L-BANK见前面文章）选择信号。我们验证了CPU对于寻址这件事只有0-27条地址线发送地址的功能而已。至于地址是多少是我们人工来干预的，总共0-26 27地址线。那么第25号线、26根线组成最大寻址64M。高两位用来给bank寻址，这个线性空间64M 和128M就完全说通了。也就是说地址线具体怎么用，是根据我们怎么连接芯片来决定的。
